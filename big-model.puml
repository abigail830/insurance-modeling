@startuml
title "统一业务逻辑模型 (V8.0 - 融合理赔与客户服务)"
hide empty members

' --- 合约包 ---
package "合约上下文 (Contract Context)" {
  entity "合约持有人 (ContractHolder)" as contract_holder {
    * HolderID: UUID <<PK>>
    --
    Name: text
  }

  entity "合约 (Contract)" as contract {
    * ContractID: UUID <<PK>>
    --
    # HolderID: UUID <<FK>>
  }

  contract_holder ||--o{ contract : "持有"
}

' --- 产品包 ---
package "产品上下文 (Product Context)" {
  entity "保险产品 (Product)" as product {
    * ProductID: UUID <<PK>>
    --
    ProductCode: Varchar
    ProductName: text
    ProductLine: text
    note: "险种大类: 寿险/健康险/意外险等"
    ProductRole: text
    note: "产品角色: 主险/附加险"
  }

  entity "保障项目 (BenefitItem)" as liability {
    * ItemID: UUID <<PK>>
    --
    # ProductID: UUID <<FK>>
    ItemName: text
    ItemCode: text
    ItemCategory: text
    note: "类别: 赔付责任/给付权益/契约权益/服务权益"
  }

  product ||--o{ liability : "包含"
}


' --- 保单包 ---
package "保单上下文 (Policy Context)" {
  entity "投保人 (Policyholder)" as policyholder {
    * PolicyholderID: UUID <<PK>>
    --
    Name: text
  }

  entity "被保险人 (Insured)" as insured {
    * InsuredID: UUID <<PK>>
    --
    Name: text
    IDNumber: text
  }

  entity "受益人 (Beneficiary)" as beneficiary {
    * BeneficiaryID: UUID <<PK>>
    --
    Name: text
    IDNumber: text
    PayoutPercentage: float
    BeneficiaryType: text
  }

  entity "保单 (Policy)" as policy {
    * PolicyNumber: Varchar <<PK>>
    --
    # ContractID: UUID <<FK>>
    # PolicyholderID: UUID <<FK>>
    # InsuredID: UUID <<FK>>
    # BeneficiaryID: UUID <<FK>>
    # ProductID: UUID <<FK>>
  }

  policyholder ||--o{ policy : "投保"
  insured ||--o{ policy : "被保障"
  beneficiary ||--o{ policy : "受益"
}

' --- 理赔交易包 ---
package "理赔上下文 (Claim Context)" {
  entity "理赔交易 (ClaimTransaction)" as claim {
    * ClaimTransactionID: UUID <<PK>>
    --
    # PolicyNumber: Varchar <<FK>>
    # BenefitItemID: UUID <<FK>>
    note: "指向具体的保障项目"
    DeceasedInsuredName: text
    PayeeBeneficiaryName: text
  }
}

' --- 新增：服务交易包 ---
package "服务交易上下文 (Service Transaction Context)" {
    entity "服务交易 (ServiceTransaction)" as service_transaction {
        * ServiceTransactionID: UUID <<PK>>
        --
        # PolicyNumber: Varchar <<FK>>
        TransactionType: text
        note: "提款/解约/贷款等 [cite: 17, 20, 21]"
        Amount: decimal
        IsRegular: boolean [cite: 22]
        note: "是否为定期交易"
    }

    entity "银行账户 (BankDetail)" as bank_detail {
        * BankDetailID: UUID <<PK>>
        --
        # HolderID: UUID <<FK>>
        BankName: text
        AccountNumber: text
    }

    entity "披露信息 (Disclosure)" as disclosure {
        * DisclosureID: UUID <<PK>>
        --
        # ServiceTransactionID: UUID <<FK>>
        Content: text
        note: "动态生成的条款 "
    }

    service_transaction ||--|| disclosure : "生成"
    contract_holder ||--o{ bank_detail : "拥有"
    service_transaction }o--|| bank_detail : "指定收款账户"
}


' --- 案例管理包 (扩展后) ---
package "案例管理上下文 (Case Management Context)" {
  entity "发起人 (Initiator)" as initiator {
    * InitiatorID: UUID <<PK>>
    --
    Name: text
    Phone: text
    Email: text
    Relationship: text
    note: "投保人/受益人/家属等"
  }

  entity "内部员工 (Employee)" as employee {
    * EmployeeID: UUID <<PK>>
    --
    Name: text
    Email: text
    Department: text
    Role: text
  }

  entity "文档 (Document)" as document {
    * DocumentID: UUID <<PK>>
    --
    # CaseID: UUID <<FK>>
    DocumentType: text
  }

  entity "案例 (Case)" as case <<abstract>> {
    * CaseID: UUID <<PK>>
    --
    # InitiatorID: UUID <<FK>>
    # CurrentOwnerID: UUID <<FK>>
    --
    CaseNumber: text
    Status: text
    Priority: text
    CreatedAt: datetime
    UpdatedAt: datetime
    Description: text
  }

  entity "理赔案例 (ClaimCase)" as claim_case {
    * CaseID: UUID <<PK>>
    --
    # ClaimTransactionID: UUID <<FK>>
    --
    ClaimType: text
    EstimatedAmount: decimal
    ActualAmount: decimal
  }

  entity "服务案例 (ServiceCase)" as service_case {
    * CaseID: UUID <<PK>>
    --
    # ServiceTransactionID: UUID <<FK>>
    --
    ServiceType: text
    note: "对应服务交易类型"
  }

  entity "案例历史 (CaseHistory)" as case_history {
    * HistoryID: UUID <<PK>>
    --
    # CaseID: UUID <<FK>>
    # OperatorID: UUID <<FK>>
    --
    Action: text
    FromStatus: text
    ToStatus: text
    Comment: text
    Timestamp: datetime
  }

  initiator ||--o{ case : "发起申请"
  employee ||--o{ case : "当前负责"
  case ||--o{ case_history : "记录"
  case ||--o{ document : "需要"
  case <|-- claim_case : "实现"
  case <|-- service_case : "实现" ' 新增的继承关系
  employee ||--o{ case_history : "操作处理"
}

' --- 包间关系 ---
contract ||--o{ policy : "生成"
product }o.. policy : "实例化为"

' 理赔流程
policy ||--o{ claim : "产生"
liability }o.. claim : "理赔申请针对"
claim ||--|| claim_case : "创建"

' 新增：客户服务流程
policy ||--o{ service_transaction : "产生"
service_transaction ||--|| service_case : "创建"
@enduml